# Довідник API

Бекенд на FastAPI. Всі сесії використовують HttpOnly, SameSite=Lax кукі.

## Автентифікація

| Кукі | Встановлюється | Призначення |
|------|----------------|-------------|
| `p2s_session` | `/auth/discord/callback` | Сесія користувача |
| `p2s_admin` | `/admin/login` | Сесія адміністратора |

## Здоров'я та інфраструктура

| Метод | Шлях | Опис |
|-------|------|------|
| GET | `/healthz` | Перевірка здоров'я → `{ status: "ok" }` |
| GET | `/livez` | Перевірка життєздатності |
| GET | `/readyz` | Перевірка готовності |
| GET | `/metrics` | Метрики Prometheus |

## Автентифікація

| Метод | Шлях | Опис |
|-------|------|------|
| GET | `/auth/discord/login` | Перенаправлення на Discord OAuth |
| GET | `/auth/discord/callback` | OAuth зворотний виклик — встановлює кукі `p2s_session` |

## Ендпоінти користувача

Потребують кукі `p2s_session`.

| Метод | Шлях | Опис |
|-------|------|------|
| POST | `/link/wallet` | Прив'язати адресу `ban_`. Тіло: `{ "banano_address": "ban_..." }` |
| POST | `/me/reverify` | Повторно запустити верифікацію Yunite |
| GET | `/me/status` | Поточний статус користувача, гаманець, накопичені нагороди |
| GET | `/me/payouts` | Історія виплат користувача |
| GET | `/me/accruals` | Історія нарахувань користувача |

## Публічний API

Автентифікація не потрібна.

| Метод | Шлях | Опис |
|-------|------|------|
| GET | `/api/leaderboard` | Топ гравців за вбивствами та заробітком |
| GET | `/api/feed` | Стрічка останньої активності (виплати, нарахування) |
| GET | `/api/donate-info` | Адреса гаманця оператора + баланс для донатів |
| GET | `/api/scheduler/countdown` | Секунди до наступного циклу нарахування/розрахунку |
| GET | `/api/donations` | Прогрес донатів, етапи, поточний множник |
| GET | `/config/product` | Публічна конфігурація продукту (назва додатку, прапорці функцій) |

## Ендпоінти адміністратора

Потребують кукі `p2s_admin`.

| Метод | Шлях | Опис |
|-------|------|------|
| POST | `/admin/login` | Вхід адміністратора. Тіло: `{ "email": "..." }` |
| POST | `/admin/reverify` | Примусова ре-верифікація користувача. Тіло: `{ "discord_id": "..." }` |
| POST | `/admin/payouts/retry` | Повторити невдалу виплату. Тіло: `{ "payout_id": 123 }` |
| GET | `/admin/audit` | Журнал аудиту адміністратора |
| GET | `/admin/stats` | Системна статистика |
| GET | `/admin/health/extended` | Розширена перевірка здоров'я |
| POST | `/admin/config/operator-seed` | Встановити зашифрований seed оператора |
| GET | `/admin/config/operator-seed/status` | Перевірити наявність seed оператора |
| GET | `/admin/scheduler/status` | Поточний стан планувальника |
| POST | `/admin/scheduler/trigger` | Запустити цикл планувальника |
| POST | `/admin/scheduler/settle` | Запустити лише розрахунок |
| GET | `/admin/scheduler/config` | Отримати конфігурацію планувальника |
| POST | `/admin/scheduler/config` | Оновити конфігурацію планувальника |
| GET | `/admin/payout/config` | Отримати конфігурацію виплат (ban_per_kill, ліміти) |
| POST | `/admin/payout/config` | Оновити конфігурацію виплат |

## Демо-ендпоінти

Доступні в режимі розробки/демо.

| Метод | Шлях | Опис |
|-------|------|------|
| POST | `/auth/demo-login` | Вхід без Discord OAuth |
| POST | `/demo/seed` | Заповнити БД тестовими даними |
| POST | `/demo/run-scheduler` | Негайно запустити цикл планувальника |
| POST | `/demo/clear` | Очистити всі демо-дані |

## Налагодження

| Метод | Шлях | Опис |
|-------|------|------|
| GET | `/debug/yunite` | Перевірити з'єднання з Yunite API |

## Примітки

- **Режим dry-run** (`P2S_DRY_RUN=true`): пропускає зовнішні API виклики та транзакції блокчейну.
- Сесії підписані HMAC з `SESSION_SECRET` та включають час закінчення.
- Помилки використовують стандартні HTTP коди статусу (400, 401, 403, 404).
